# extract and reformat data from 10x Cell Ranger DNA input
# https://support.10xgenomics.com/single-cell-dna/software/pipelines/latest/output/hdf5

#=====================================================================================
# script initialization
#-------------------------------------------------------------------------------------
# load packages
message("initializing")
suppressPackageStartupMessages({
    library(rhdf5)
    library(data.table)
    library(zoo)
    library(parallel)
})
#-------------------------------------------------------------------------------------
# parse environment variables
env <- as.list(Sys.getenv())
rUtilDir <- file.path(env$MODULES_DIR, 'utilities', 'R')
source(file.path(rUtilDir, 'workflow.R'))
checkEnvVars(list(
    string = c(
        'INPUT_DIR',
        'INPUT_NAME',
        'BAD_REGIONS_FILE',
        'EXTRACT_FILE'
    ),
    integer = c(
        "PLOIDY",
        "MAX_WINDOW_BINS",
        "N_CPU"
    )
))
#-------------------------------------------------------------------------------------
# set some options
setDTthreads(env$N_CPU)
options(scipen = 999) # prevent 1+e6 in printed, which leads to read.table error when integer expected
options(warn=2)
#=====================================================================================

#=====================================================================================
# extract required data elements from Cell Ranger hdf5 file
# discard some Cell Ranger outputs, e.g., normalization and cell clusters
#-------------------------------------------------------------------------------------
message("loading Cell Ranger data")

# find the Cell Ranger hdf5 file, can be nested in a subfolder of inputDir/inputName
inputDir <- file.path(env$INPUT_DIR, env$INPUT_NAME)
h5FileName <- "cnv_data.h5"
h5Files <- list.files(
    path = inputDir, 
    pattern = h5FileName, 
    full.names = TRUE, 
    recursive = TRUE
)
h5File <- h5Files[1]
if(h5File == "") stop(paste("file", h5FileName, "not found in directory", inputDir))

# extract the required data elements
h5 = H5Fopen(h5File)
constants <- h5read(h5, "constants", bit64conversion = "int")
genome_tracks <- h5read(h5, "genome_tracks", bit64conversion = "int")
genome_tracks$is_mappable <- NULL
metadata <- h5read(h5, "metadata", bit64conversion = "int")
per_cell_summary_metrics <- h5read(h5, "per_cell_summary_metrics", bit64conversion = "int")
raw_counts <- h5read(h5, "raw_counts", bit64conversion = "int")
H5Fclose(h5)
rm(h5FileName, h5Files, h5File, h5)
#=====================================================================================

#=====================================================================================
# assemble the parts of an initial SummarizedExperiment
#-------------------------------------------------------------------------------------
message("parsing genome bin descriptions")
autosomes <- paste0("chr", 1:100)
badRegions <- fread(env$BAD_REGIONS_FILE)[, 1:3]
setnames(badRegions, c("chrom", "start", "end"))
rowRanges <- do.call(rbind, mclapply(seq_along(constants$chroms), function(i){
    chrom <- constants$chroms[i]
    nBins <- constants$num_bins_per_chrom[i]
    start <- seq(from = 1, by = constants$bin_size, length.out = nBins)
    dt <- data.table(
        chrom = rep(chrom, nBins),
        start = as.integer(start),
        end   = as.integer(start + constants$bin_size - 1),
        gc_fraction = as.double(genome_tracks$gc_fraction[[chrom]]), 
        mappability = as.double(genome_tracks$mappability[[chrom]]),
        autosome    = chrom %in% autosomes
    )
    badRegions <- badRegions[chrom == constants$chroms[i], 2:3]
    setkey(badRegions, start, end)     
    dt[, bad_region := !is.na(foverlaps(dt, badRegions, type = "any", mult = "first", which = TRUE))]
    dt
}, mc.cores = env$N_CPU))
rm(autosomes, badRegions, genome_tracks)
# -------------------------------------------------------------------------------------
message("parsing cell metrics")
cell_ids <- as.character(per_cell_summary_metrics$cell_id)
colData <- as.data.table(per_cell_summary_metrics)
colData[, cell_id := cell_ids]
colData[, modal_CN := env$PLOIDY]
setkey(colData, "cell_id")
rm(per_cell_summary_metrics)
# -------------------------------------------------------------------------------------
message("parsing cell raw bin counts")
raw_counts <- do.call(rbind, mclapply(constants$chroms, function(chrom){
    as.data.table(raw_counts[[chrom]][, 1:constants$num_cells]) # rows = all bins, columns = all cells
}, mc.cores = env$N_CPU))
setnames(raw_counts, cell_ids)
#=====================================================================================

#=====================================================================================
# permanently remove bins in bad genome regions; windows will span them
#-------------------------------------------------------------------------------------
message("removing bins in bad genome regions")
raw_counts <- raw_counts[rowRanges$bad_region == FALSE]
rowRanges  <-  rowRanges[rowRanges$bad_region == FALSE]
#=====================================================================================

#=====================================================================================
# pre-calculate the bin corrections for all required window sizes
#-------------------------------------------------------------------------------------
message("pre-calculating bin corrections for all required window sizes")
window_sizes <- seq(1, env$MAX_WINDOW_BINS, 2)
rollingRanges <- mclapply(window_sizes, function(window_size){
    rmean <- function(x) rollmean( x, window_size, na.pad = TRUE, align = "center")
    window_flank <- (window_size - 1) / 2
    startUnit  <- c(TRUE, rep(FALSE, window_size - 1))
    endUnit    <- c(rep(FALSE, window_size - 1), TRUE)    
    windowUnit <- c(rep(FALSE, window_flank), TRUE, rep(FALSE, window_flank))
    rowRanges[,
        .(
            start = rep(startUnit, ceiling(.N / window_size))[1:.N],
            end   = rep(endUnit,   ceiling(.N / window_size))[1:.N],
            gc_fraction = as.double(rmean(gc_fraction)), 
            mappability = as.double(rmean(mappability)),
            reference_window = rep(windowUnit, ceiling(.N / window_size))[1:.N]
        ),
        by = "chrom"
    ]
}, mc.cores = env$N_CPU)
names(rollingRanges) <- paste("w", window_sizes, sep = "_")
#=====================================================================================

#=====================================================================================
# save the interim output file
#-------------------------------------------------------------------------------------
save.image(file = env$EXTRACT_FILE)
#=====================================================================================

# 0  cell_barcodes            H5I_DATASET STRING 329
# 1  cnvs                     H5I_GROUP             
# 2  constants                H5I_GROUP             
# 3  genome_tracks            H5I_GROUP             
# 4  metadata                 H5I_GROUP             
# 5  normalization_parameters H5I_GROUP             
# 6  normalized_counts        H5I_GROUP             
# 7  per_cell_summary_metrics H5I_GROUP             
# 8  raw_counts               H5I_GROUP             
# 9  summary_metrics          H5I_GROUP             
# 10 tree                     H5I_GROUP 

# for tables based on the 10x clustering tree (e.g., raw_counts):
#   rows 0 to N-1 correspond to the single cell copy number calls
#   rows N to 2N-2 represent the groups of cells defined by the hierarchical clustering

# cell_barcodes
#  chr [1:329(1d)] "AAACGGGTCTCGTGGG-1" "AAAGATGAGATCTGCT-1" ...

# cnvs
# List of 21
#  $ chr1 : int [1:9774, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr10: int [1:6535, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr11: int [1:6105, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr12: int [1:6007, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr13: int [1:6022, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr14: int [1:6246, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr15: int [1:5203, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr16: int [1:4911, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr17: int [1:4750, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr18: int [1:4536, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr19: int [1:3072, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr2 : int [1:9106, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr3 : int [1:8002, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr4 : int [1:7826, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr5 : int [1:7592, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr6 : int [1:7487, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr7 : int [1:7273, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr8 : int [1:6471, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chr9 : int [1:6230, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chrX : int [1:8552, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...
#  $ chrY : int [1:4588, 1:657] -128 -128 -128 -128 -128 -128 -128 -128 -128 -128 ...

# constants
# List of 7
#  $ bin_size          :integer64 20000 
#  $ chroms            : chr [1:21(1d)] "chr1" "chr2" "chr3" "chr4" ...
#  $ genome_bins       :integer64 136288 
#  $ num_bins_per_chrom:integer64 [1:21] 9774 9106 8002 7826 7592 7487 7273 6471 ... 
#  $ num_cells         :integer64 329 
#  $ num_chroms        :integer64 21 
#  $ num_nodes         :integer64 657 

# genome_tracks
# List of 4
#  $ gc_fraction:List of 21
#   ..$ chr1 : num [1:9774(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr10: num [1:6535(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr11: num [1:6105(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr12: num [1:6007(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr13: num [1:6022(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr14: num [1:6246(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr15: num [1:5203(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr16: num [1:4911(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr17: num [1:4750(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr18: num [1:4536(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr19: num [1:3072(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr2 : num [1:9106(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr3 : num [1:8002(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr4 : num [1:7826(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr5 : num [1:7592(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr6 : num [1:7487(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr7 : num [1:7273(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr8 : num [1:6471(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr9 : num [1:6230(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chrX : num [1:8552(1d)] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chrY : num [1:4588(1d)] 0 0 0 0 0 ...
#  $ is_mappable:List of 21  ##### threshold 90%
#   ..$ chr1 : Factor[1:9774(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr10: Factor[1:6535(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr11: Factor[1:6105(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr12: Factor[1:6007(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr13: Factor[1:6022(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr14: Factor[1:6246(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr15: Factor[1:5203(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr16: Factor[1:4911(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr17: Factor[1:4750(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr18: Factor[1:4536(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr19: Factor[1:3072(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr2 : Factor[1:9106(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr3 : Factor[1:8002(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr4 : Factor[1:7826(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr5 : Factor[1:7592(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr6 : Factor[1:7487(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr7 : Factor[1:7273(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr8 : Factor[1:6471(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr9 : Factor[1:6230(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chrX : Factor[1:8552(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chrY : Factor[1:4588(1d)] w/ 2 levels "FALSE","TRUE": 1 1 1 1 1 1 1 1 1 1 ...
#  $ mappability:List of 21
#   ..$ chr1 : num [1:9774, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr10: num [1:6535, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr11: num [1:6105, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr12: num [1:6007, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr13: num [1:6022, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr14: num [1:6246, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr15: num [1:5203, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr16: num [1:4911, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr17: num [1:4750, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr18: num [1:4536, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr19: num [1:3072, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr2 : num [1:9106, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr3 : num [1:8002, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr4 : num [1:7826, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr5 : num [1:7592, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr6 : num [1:7487, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr7 : num [1:7273, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr8 : num [1:6471, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chr9 : num [1:6230, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chrX : num [1:8552, 1] 0 0 0 0 0 0 0 0 0 0 ...
#   ..$ chrY : num [1:4588, 1] 0 0 0 0 0 ...
#  $ n_fraction :List of 21
#   ..$ chr1 : num [1:9774(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr10: num [1:6535(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr11: num [1:6105(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr12: num [1:6007(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr13: num [1:6022(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr14: num [1:6246(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr15: num [1:5203(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr16: num [1:4911(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr17: num [1:4750(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr18: num [1:4536(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr19: num [1:3072(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr2 : num [1:9106(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr3 : num [1:8002(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr4 : num [1:7826(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr5 : num [1:7592(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr6 : num [1:7487(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr7 : num [1:7273(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr8 : num [1:6471(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chr9 : num [1:6230(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chrX : num [1:8552(1d)] 1 1 1 1 1 1 1 1 1 1 ...
#   ..$ chrY : num [1:4588(1d)] 1 1 1 1 1 0.5 0 0 0 0 ...

# metadata
# List of 9
#  $ annotation      : chr [1(1d)] "gencode.vM17"
#  $ assembly        : chr [1(1d)] "GRCm38"
#  $ library_id      :'data.frame':       1 obs. of  2 variables:
#   ..$ gem_group : int [1(1d)] 1
#   ..$ library_id: chr [1(1d)] "LibraryNotSpecified"
#  $ organism        : chr [1(1d)] "Mus_musculus"
#  $ pipeline        : chr [1(1d)] "cnv"
#  $ pipeline_version: chr [1(1d)] "1.1.0"
#  $ reference_path  : chr [1(1d)] "/nfs/turbo/agc-data/refs/OLD_STRUCTURE/archived_refs/cellranger-dna/refdata-GRCm38-1.0.0"
#  $ sample_desc     : chr [1(1d)] ""
#  $ sample_id       : chr [1(1d)] "Sample_6774-SA-1"

# normalization_parameters
# List of 3
#  $ linear   : num [1:657(1d)] -0.6 0 -9.04 0 -5.04 -0.4 0 -0.4 -0.6 0 ...
#  $ quadratic: num [1:657(1d)] 0 0 16.72 0 4.56 ...
#  $ scale    : num [1:657(1d)] 1 1 1 1 1 1 1 1 1 1 ...

# normalized_counts 

# per_cell_summary_metrics
# List of 19
#  $ barcode                    : chr [1:329(1d)] "AAACGGGTCTCGTGGG-1" "AAAGATGAGATCTGCT-1" "AAAGCAAAGGCAACAC-1" "AAAGCAATCTGTGGCG-1" ...
#  $ cell_id                    :integer64 [1:329] 0 1 2 3 4 5 6 7 ... 
#  $ effective_depth_of_coverage: num [1:329(1d)] 0.1249 0.0269 0.0945 0.0364 0.0769 ...
#  $ effective_reads_per_1Mbp   :integer64 [1:329] 659 125 455 160 397 692 659 668 ... 
#  $ est_cnv_resolution_mb      : num [1:329(1d)] 0.58 4.5 2.46 3.96 1.74 ...
#  $ frac_mapped_duplicates     : num [1:329(1d)] 0.139 0.126 0.136 0.121 0.135 ...
#  $ is_high_dimapd             :integer64 [1:329] 0 0 1 0 0 0 0 0 ... 
#  $ is_noisy                   :integer64 [1:329] 0 0 1 1 1 0 0 0 ... 
#  $ mean_ploidy                : num [1:329(1d)] 2.01 3.87 1.93 1.63 2.02 ...
#  $ normalized_dimapd          : num [1:329(1d)] 1.3 1.5 2.16 1.62 1.69 ...
#  $ normalized_mapd            : num [1:329(1d)] 0.0858 0.2547 0.1871 0.2436 0.1549 ...
#  $ num_duplicate_reads        :integer64 [1:329] 352062 68969 262703 91582 209077 361640 336197 351904 ... 
#  $ num_lowmapq_reads          :integer64 [1:329] 368158 136349 416266 225476 252830 379944 408515 390655 ... 
#  $ num_mapped_dedup_reads     :integer64 [1:329] 1797186 341058 1238990 437303 1081436 1887232 1794852 1821332 ... 
#  $ num_unmapped_reads         :integer64 [1:329] 8518 2210 8303 3357 5577 8324 10280 8205 ... 
#  $ ploidy_confidence          :integer64 [1:329] -2 -3 -4 -4 -4 -2 -2 -2 ... 
#  $ raw_dimapd                 : num [1:329(1d)] 1.3 1.5 2.16 1.62 1.69 ...
#  $ raw_mapd                   : num [1:329(1d)] 0.0858 0.2547 0.1871 0.2436 0.1549 ...
#  $ total_num_reads            :integer64 [1:329] 2525924 548586 1926262 757718 1548920 2637140 2549844 2572096 ... 

# raw_counts
# List of 21
#  $ chr1 : num [1:9774, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr10: num [1:6535, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr11: num [1:6105, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr12: num [1:6007, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr13: num [1:6022, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr14: num [1:6246, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr15: num [1:5203, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr16: num [1:4911, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr17: num [1:4750, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr18: num [1:4536, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr19: num [1:3072, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr2 : num [1:9106, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr3 : num [1:8002, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr4 : num [1:7826, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr5 : num [1:7592, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr6 : num [1:7487, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr7 : num [1:7273, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr8 : num [1:6471, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chr9 : num [1:6230, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chrX : num [1:8552, 1:657] 0 0 0 0 0 0 0 0 0 0 ...
#  $ chrY : num [1:4588, 1:657] 0 0 0 0 0 0 0 0 0 0 ...

# summary_metrics
# List of 2
#  $ 1  :List of 43
#   ..$ bad_bc_count            :integer64 54716513 
#   ..$ bc_q20_bases            :integer64 7011595037 
#   ..$ bc_q20_bases_fract      : num 0.993
#   ..$ bc_q30_bases            :integer64 6882451779 
#   ..$ bc_q30_bases_fract      : num 0.974
#   ..$ bc_tot_bases            :integer64 7063053802 
#   ..$ clipped_base_fract      : num 0.0767
#   ..$ conf_map_fract          : num 0.768
#   ..$ correct_bc_rate         : num 0.876
#   ..$ iqr_insert_size         :integer64 132 
#   ..$ mapped_bases            :integer64 114374060587 
#   ..$ median_insert_size      :integer64 215 
#   ..$ num_conf_mapped         :integer64 677936170 
#   ..$ num_far_chimeras        :integer64 4378768 
#   ..$ num_pos_chimeras        :integer64 289956795 
#   ..$ num_reads               :integer64 882904340 
#   ..$ num_single_mapped       :integer64 7659416 
#   ..$ num_unmapped            :integer64 19245892 
#   ..$ r1_contains_N           :integer64 982760 
#   ..$ r1_len                  :integer64 135 
#   ..$ r1_q20_bases            :integer64 57118627201 
#   ..$ r1_q20_bases_fract      : num 0.958
#   ..$ r1_q30_bases            :integer64 54594965350 
#   ..$ r1_q30_bases_fract      : num 0.916
#   ..$ r1_tot_bases            :integer64 59594833189 
#   ..$ r2_contains_N           :integer64 841674 
#   ..$ r2_len                  :integer64 151 
#   ..$ r2_q20_bases            :integer64 63756033888 
#   ..$ r2_q20_bases_fract      : num 0.956
#   ..$ r2_q30_bases            :integer64 60579776126 
#   ..$ r2_q30_bases_fract      : num 0.909
#   ..$ r2_tot_bases            :integer64 66658409790 
#   ..$ raw_bc_on_whitelist     :integer64 800914680 
#   ..$ reads_containing_N_fract: num 0.00207
#   ..$ si_q20_bases            :integer64 0 
#   ..$ si_q20_bases_fract      : num NaN
#   ..$ si_q30_bases            :integer64 0 
#   ..$ si_q30_bases_fract      : num NaN
#   ..$ si_tot_bases            :integer64 0 
#   ..$ single_mapped_fract     : num 0.00868
#   ..$ soft_clipped_bases      :integer64 9678675705 
#   ..$ total_bases             :integer64 126255320620 
#   ..$ unmapped_fract          : num 0.0218
#  $ all:List of 43
#   ..$ bad_bc_count            :integer64 54716513 
#   ..$ bc_q20_bases            :integer64 7011595037 
#   ..$ bc_q20_bases_fract      : num 0.993
#   ..$ bc_q30_bases            :integer64 6882451779 
#   ..$ bc_q30_bases_fract      : num 0.974
#   ..$ bc_tot_bases            :integer64 7063053802 
#   ..$ clipped_base_fract      : num 0.0767
#   ..$ conf_map_fract          : num 0.768
#   ..$ correct_bc_rate         : num 0.876
#   ..$ iqr_insert_size         :integer64 132 
#   ..$ mapped_bases            :integer64 114374060587 
#   ..$ median_insert_size      :integer64 215 
#   ..$ num_conf_mapped         :integer64 677936170 
#   ..$ num_far_chimeras        :integer64 4378768 
#   ..$ num_pos_chimeras        :integer64 289956795 
#   ..$ num_reads               :integer64 882904340 
#   ..$ num_single_mapped       :integer64 7659416 
#   ..$ num_unmapped            :integer64 19245892 
#   ..$ r1_contains_N           :integer64 982760 
#   ..$ r1_len                  :integer64 135 
#   ..$ r1_q20_bases            :integer64 57118627201 
#   ..$ r1_q20_bases_fract      : num 0.958
#   ..$ r1_q30_bases            :integer64 54594965350 
#   ..$ r1_q30_bases_fract      : num 0.916
#   ..$ r1_tot_bases            :integer64 59594833189 
#   ..$ r2_contains_N           :integer64 841674 
#   ..$ r2_len                  :integer64 151 
#   ..$ r2_q20_bases            :integer64 63756033888 
#   ..$ r2_q20_bases_fract      : num 0.956
#   ..$ r2_q30_bases            :integer64 60579776126 
#   ..$ r2_q30_bases_fract      : num 0.909
#   ..$ r2_tot_bases            :integer64 66658409790 
#   ..$ raw_bc_on_whitelist     :integer64 800914680 
#   ..$ reads_containing_N_fract: num 0.00207
#   ..$ si_q20_bases            :integer64 0 
#   ..$ si_q20_bases_fract      : num NaN
#   ..$ si_q30_bases            :integer64 0 
#   ..$ si_q30_bases_fract      : num NaN
#   ..$ si_tot_bases            :integer64 0 
#   ..$ single_mapped_fract     : num 0.00868
#   ..$ soft_clipped_bases      :integer64 9678675705 
#   ..$ total_bases             :integer64 126255320620 
#   ..$ unmapped_fract          : num 0.0218

# tree
# List of 3
#  $ Z               : num [1:4, 1:328] 117 272 29 2 133 156 29 2 104 330 ...
#  $ heterogeneity   :List of 21
#   ..$ chr1 : num [1:9774, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr10: num [1:6535, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr11: num [1:6105, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr12: num [1:6007, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr13: num [1:6022, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr14: num [1:6246, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr15: num [1:5203, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr16: num [1:4911, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr17: num [1:4750, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr18: num [1:4536, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr19: num [1:3072, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr2 : num [1:9106, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr3 : num [1:8002, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr4 : num [1:7826, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr5 : num [1:7592, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr6 : num [1:7487, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr7 : num [1:7273, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr8 : num [1:6471, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chr9 : num [1:6230, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chrX : num [1:8552, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#   ..$ chrY : num [1:4588, 1:328] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...
#  $ is_cell_in_group: int [1:329, 1:328] 0 0 0 0 0 0 0 0 0 0 ...
