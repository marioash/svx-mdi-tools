#----------------------------------------------------------------------
# handle unique junction loading and filtering
#----------------------------------------------------------------------

# app-specific junction loading
# here, coerce svWGS format toward svPore format (result is cached upstream)
svx_loadJunctions_app <- function(sourceId){
    startSpinner(session, message = "loading jxns (slow, runs once)")
    jxns <- readRDS(getSourceFilePath(sourceId, "structuralVariants")) 
    chroms <- readRDS(getSourceFilePath(sourceId, "chromosomesFile"))
    samples_ <- read_yaml(getSourceFilePath(sourceId, "metadata"))$SAMPLES
    jt <- svx_jxnTypes
    setkey(jt, altCode)
    jxns[, ":="(
        edgeType = jt[JXN_TYPE, code],
        chromIndex1 = unlist(chroms$chromIndex[CHROM_1]),
        chromIndex2 = unlist(chroms$chromIndex[CHROM_2]),
        strand1 = ifelse(SIDE_1 == "L", "+", "-"),
        strand2 = ifelse(SIDE_2 == "R", "+", "-"),
        nInstances = N_TOTAL, 
        nSamples = N_SAMPLES
    )]
    jxns[, samples := paste(sapply(samples_, function(x) if(.SD[[x]] > 0) x else NULL), collapse = ","), by = .(SV_ID)]
    jxns[, ":="(
        node1 = getSignedNode(chroms$chromSizes, chromIndex1, POS_1, strand1),
        node2 = getSignedNode(chroms$chromSizes, chromIndex2, POS_2, strand2) 
    )]
    jxns[, isCanonical := isCanonicalStrand_vectorized(node1, node2)]
    jxns[, ":="(
        cChromIndex1 = ifelse(isCanonical, chromIndex1, chromIndex2),
        cChromIndex2 = ifelse(isCanonical, chromIndex2, chromIndex1),
        cRefPos1     = ifelse(isCanonical, POS_1, POS_2),
        cRefPos2     = ifelse(isCanonical, POS_2, POS_1),
        cStrand1     = ifelse(ifelse(isCanonical, strand1, strand2) == "+", 1, -1),
        cStrand2     = ifelse(ifelse(isCanonical, strand2, strand1) == "+", 1, -1)
    )] 
    jxns
}

# get a single junction cluster for the object table
svWGS_getJunction <- function(x){
    svx_loadJunctions(x$sourceId)[SV_ID == x$SV_ID]
}


# Classes ‘data.table’ and 'data.frame':  6016 obs. of  45 variables:
#  $ SV_ID           : chr  "10002:1" "10028:1" "10037:1" "10038:1" ...
#  $ MAPQ_1          : chr  "60,60,45,60,60,60,60,60,60,60,60,47,60,60,60,60,47,60
#  $ UMI_1           : chr  "1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
#  $ N_TOTAL         : int  63 21 9 64 5 36 61 53 43 76 ...
#  $ N_GAPS          : int  27 21 9 35 5 16 22 25 43 30 ...
#  $ N_SPLITS        : int  29 0 0 22 0 18 36 25 0 42 ...
#  $ N_OUTER_CLIPS   : int  7 0 0 7 0 2 3 3 0 4 ...
#  $ JXN_TYPE        : chr  "L" "L" "L" "L" ...
#  $ N_DUPLEX        : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ N_DUPLEX_GS     : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ STRAND_COUNT    : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ STRAND_COUNT_GS : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ STRAND_COUNT1   : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ STRAND_COUNT2   : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ TARGET_CLASS    : chr  "X" "X" "X" "X" ...
#  $ SHARED_PROPER   : num  0 0 0 0 0 0 0 0 0 0 ...
#  $ SHARED_PROPER_GS: num  0 0 0 0 0 0 0 0 0 0 ...
#  $ SAMPLES         : chr  "NA12878_cpu" "NA12878_cpu" "NA12878_cpu" "NA12878_cpu
#  $ N_SAMPLES       : int  1 1 1 1 1 1 1 1 1 1 ...
#  $ MAPQ_2          : chr  "32,42,45,39,47,52,40,42,30,60,60,47,31,42,47,60,47,41
#  $ UMI_2           : chr  "1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
#  $ CHROM_1         : chr  "chr2" "chr2" "chr2" "chr2" ...
#  $ SIDE_1          : chr  "L" "L" "L" "L" ...
#  $ POS_1           : int  193824778 203316754 207486327 207609771 209078107 2148
#  $ CHROM_2         : chr  "chr2" "chr2" "chr2" "chr2" ...
#  $ SIDE_2          : chr  "R" "R" "R" "R" ...
#  $ POS_2           : int  193834042 203327011 207494695 207612061 209084224 2148
#  $ JUNCTION_NAME   : chr  "2:L:193824778,2:R:193834042" "2:L:203316754,2:R:20332
#  $ JUNCTION_NAMES  : chr  "2:L:193824748,2:R:193834366::2:L:193824778,2:R:193834
#  $ N_AMBIGUOUS     : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ N_DOWNSAMPLED   : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ N_COLLAPSED     : int  3 0 0 3 0 1 5 3 3 3 ...
#  $ JXN_SEQ         : chr  "AATGGAGCCAGTCCATCCTCATTGAAGTGTATGAGAAATAATCTTACTCATAG
#  $ MERGE_LEN       : int  0 0 0 0 0 0 0 0 143 0 ...
#  $ MICROHOM_LEN    : int  1 0 0 13 0 2 8 5 109 13 ...
#  $ JXN_BASES       : chr  "G" "*" "*" "AGAAAACCTATTC" ...
#  $ SV_SIZE         : num  9264 10257 8368 2290 6117 ...
#  $ GEN_REF_1       : chr  "CCATTGAGTGGAAAGTTTGCTCAAATTTTCAGTCCCAATTGTGTAAGCTGAAC
#  $ GEN_REF_2       : chr  "TGAATTTATCGAGAATTTTTAGCATGAGGGGCTGTTGAATTTTGTCAAAGGCC
#  $ GEN_COV_1       : chr  "" "" "" "" ...
#  $ GEN_COV_2       : chr  "" "" "" "" ...
#  $ TARGET_REGION   : chr  "*" "*" "*" "*" ...
#  $ TARGET_POS_1    : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ TARGET_POS_2    : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ NA12878_cpu     : int  63 21 9 64 5 36 61 53 43 76 ...
