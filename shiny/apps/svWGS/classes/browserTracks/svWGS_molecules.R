#----------------------------------------------------------------------
# handle junction loading and filtering, for molecule plots, etc.
#----------------------------------------------------------------------

# load all molecules for a specific sourceId (not filtered yet)
svWGS_loadSourceMolecules <- function(sourceId){
    req(sourceId)
    startSpinner(session, message = "loading molecules")
    sessionCache$get(
        'svWGS_molecules', 
        key = sourceId, 
        permanent = TRUE, 
        from = "ram", 
        create = "asNeeded", 
        createFn = function(...) {
            startSpinner(session, message = "loading molecules .")
            molecules <- readRDS(getSourceFilePath(sourceId, "junctionMolecules")) 
            molecules[, c('chrom1', 'side1', 'pos1') := unpackNodeNames(NODE_1)]
            molecules[, c('chrom2', 'side2', 'pos2') := unpackNodeNames(NODE_2)]
            molecules[, isOuterClip := NODE_CLASS == SVX$nodeClasses$OUTER_CLIP]
#  [1] "NODE_1"         "CLIP_LEN_1"     "CLIP_SEQ_1"     "FLAG_1"
#  [5] "POS_1"          "MAPQ_1"         "CIGAR_1"        "SEQ_1"
#  [9] "ALN_N_1"        "UMI_1"          "NODE_CLASS"     "JXN_TYPE"
# [13] "JXN_N"          "MOL_ID"         "IS_MERGED"      "IS_DUPLEX"
# [17] "STRAND_COUNT1"  "STRAND_COUNT2"  "MOL_CLASS"      "MOL_STRAND"
# [21] "IS_OUTER_CLIP1" "IS_OUTER_CLIP2" "TARGET_CLASS"   "SHARED_PROPER"
# [25] "OUT_POS1"       "OUT_POS2"       "SAMPLE"         "NODE_2"
# [29] "CLIP_LEN_2"     "CLIP_SEQ_2"     "FLAG_2"         "POS_2"
# [33] "MAPQ_2"         "CIGAR_2"        "SEQ_2"          "ALN_N_2"
# [37] "UMI_2"          "SV_ID"          "AMBIGUOUS"      "DOWNSAMPLED"
# [41] "N_COLLAPSED"    "IS_REFERENCE"   "TARGET_POS_1"   "TARGET_POS_2"            
            molecules[, ":="(
                molKey = paste(SAMPLE, MOL_ID, sep = ":")
            )]
            setkey(molecules, SV_ID) 
            molecules
        }
    )$value
}

# pull the molecules for a specific junction
svWGS_loadMolecules <- function(sourceId, svId_){
    sessionCache$get(
        'svWGS_molecules', 
        keyObject = list(sourceId = sourceId, svId = svId_), 
        permanent = FALSE, 
        from = "ram", 
        create = "asNeeded", 
        createFn = function(...) {
            molecules <- svWGS_loadSourceMolecules(sourceId)
            startSpinner(session, message = "loading junction")
            molecules[svId_]
        }
    )$value
}

# Classes ‘data.table’ and 'data.frame':  68268 obs. of  44 variables:
#  $ NODE_1        : chr  "2:L:193824748" "2:L:193824778" "2:L:193824778" "2:L:193
# 824567" ...
#  $ CLIP_LEN_1    : int  0 72 97 0 64 0 56 13 0 0 ...
#  $ CLIP_SEQ_1    : chr  "*" "TGTCACAGAGAGTCTGGTATGTTGTGTCCTTGTTCTCCTTAGCTTCAAAGA
# ACATCTTTGTTTCTGCCTTCA" "TGTCACAGAGATTCTGGTATGTTGTGTCCTTGTTCTCCTTAGCTTCAAAGAACATC
# TTTGTTTCTGCCTTCATTTCGTTATGTACCCAGTAGTCATT" "*" ...
#  $ FLAG_1        : int  97 97 2147 97 67 97 67 97 97 97 ...
#  $ POS_1         : int  193824598 193824700 193824725 193824417 193824692 193824
# 561 193824684 193824641 193824509 193824603 ...
#  $ MAPQ_1        : int  60 60 45 60 60 60 60 60 60 60 ...
#  $ CIGAR_1       : chr  "151M" "79M72S" "54M97S" "151M" ...
#  $ SEQ_1         : chr  "TCAACATTCTTTCCCTACTTGGCTCCTACATCCTGGCAGACAGAAATTTAGTCAT
# CTGAAAGGAGACAGCTCTAATGCATCTGATAATGGATGCACAGTGAAACAATGGAG"| __truncated__ "ACAATG
# GAGCCAGTCCATCCTCATTGAAGTGTATGAGAAATAATCTTACTCATAGTTTCCAATGAGATGATTAATGATGTGTCACA
# GAGAGTCTGGTATGTTGTGTCCTTG"| __truncated__ "GAAGTGTATGAGAAATAATCTTACTCATAGTTTCCAA
# TGAGATGATTAATGATGTGTCACAGAGATTCTGGTATGTTGTGTCCTTGTTCTCCTTAGCTTCAAAGAACATCT"| __t
# runcated__ "TATTTATTAGCAAGTTTCAGATCACTTCCTTCATTCAGTGCAACTTTAGAAGAGTAGATCACCACGGG
# AATTAAAACAGGGGATTGCTGAACTGTAGAACACTGAGTTCAG"| __truncated__ ...
#  $ ALN_N_1       : int  1 2 1 2 2 1 2 1 2 1 ...
#  $ UMI_1         : int  1 1 1 1 1 1 1 1 1 1 ...
#  $ NODE_CLASS    : int  0 1 1 0 1 0 1 0 0 0 ...
#  $ JXN_TYPE      : chr  "L" "L" "L" "L" ...
#  $ JXN_N         : int  1 1 1 1 1 1 1 1 1 1 ...
#  $ MOL_ID        : int  136952731 138561914 157395031 166356549 17180397 2124739
# 8 248180587 250615858 251587541 253292929 ...
#  $ IS_MERGED     : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ IS_DUPLEX     : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ STRAND_COUNT1 : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ STRAND_COUNT2 : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ MOL_CLASS     : chr  "V" "V" "V" "V" ...
#  $ MOL_STRAND    : int  0 1 0 1 1 0 1 0 1 0 ...
#  $ IS_OUTER_CLIP1: int  0 0 0 0 0 0 0 0 0 0 ...
#  $ IS_OUTER_CLIP2: int  0 0 0 0 0 0 0 0 0 0 ...
#  $ TARGET_CLASS  : chr  "X" "X" "X" "X" ...
#  $ SHARED_PROPER : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ OUT_POS1      : int  193824598 193824700 193824725 193824417 193824424 193824
# 561 193824200 193824641 193824509 193824603 ...
#  $ OUT_POS2      : int  193834516 193834373 193834367 193834260 193834106 193834
# 355 193834098 193834286 193834263 193834451 ...
#  $ SAMPLE        : chr  "NA12878_cpu" "NA12878_cpu" "NA12878_cpu" "NA12878_cpu" 
# ...
#  $ NODE_2        : chr  "2:R:193834366" "2:R:193834042" "2:R:193834042" "2:R:193
# 834110" ...
#  $ CLIP_LEN_2    : int  0 78 53 0 86 0 94 0 0 0 ...
#  $ CLIP_SEQ_2    : chr  "*" "ACAATGGAGCCAGTCCATCCTCATTGAAGTGTATGAGAAATAATCTTACTC
# ATAGTTTCCAATGAGATGATTAATGAT" "GAAGTGTATGAGAAATAATCTTACTCATAGTTTCCAATGAGATGATTAAT
# GAT" "*" ...
#  $ FLAG_2        : int  129 2209 163 129 2179 129 2179 129 129 129 ...
#  $ POS_2         : int  193834366 193834042 193834042 193834110 193834042 193834
# 205 193834042 193834136 193834113 193834301 ...
#  $ MAPQ_2        : int  32 42 45 39 47 52 40 42 30 60 ...
#  $ CIGAR_2       : chr  "151M" "78S73M" "53S98M" "151M" ...
#  $ SEQ_2         : chr  "CTGTAGATGTCTATTAGGTCCGCTTGGTGCTGAGCTGAGTTCAATGCCTGGATAT
# CTTTGTTAACTTTCTGTCTCGTTGATCTGTCTAATGTTGACAGTGGGGTGTTAAAG"| __truncated__ "ACAATG
# GAGCCAGTCCATCCTCATTGAAGTGTATGAGAAATAATCTTACTCATAGTTTCCAATGAGATGATTAATGATGTGTCACA
# GAGAGTCTGGTATGTTGTGTCCTTG"| __truncated__ "GAAGTGTATGAGAAATAATCTTACTCATAGTTTCCAA
# TGAGATGATTAATGATGTGTCACAGAGATTCTGGTATGTTGTGTCCTTGTTCTCCTTAGCTTCAAAGAACATCT"| __t
# runcated__ "CTTCATTTCGTTATGTACCCAGTAGTCATTCAGGAGCAGGTCATTCAATTTCCATGTAGTTGAGTGGT
# TTTGAGTGAGTTTCTTAATCCTGAGTTCTAGTTTGATTGCACT"| __truncated__ ...
#  $ ALN_N_2       : int  2 3 2 1 1 2 1 2 1 2 ...
#  $ UMI_2         : int  1 1 1 1 1 1 1 1 1 1 ...
#  $ SV_ID         : chr  "10002:1" "10002:1" "10002:1" "10002:1" ...
#  $ AMBIGUOUS     : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ DOWNSAMPLED   : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ N_COLLAPSED   : int  1 1 1 1 1 1 1 1 1 2 ...
#  $ IS_REFERENCE  : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ TARGET_POS_1  : int  0 0 0 0 0 0 0 0 0 0 ...
#  $ TARGET_POS_2  : int  0 0 0 0 0 0 0 0 0 0 ...
